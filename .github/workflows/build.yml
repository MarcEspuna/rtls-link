name: Build and Test ESP32 Applications

on:
  push:
    branches: [ main, develop ]
  pull_request:  # Run on any PR to any branch
  workflow_dispatch:

env:
  DOCKER_IMAGE: ghcr.io/marcespuna/rtls-link-platformio:v1.0.0
  PIO_CACHE: ${{ github.workspace }}/.platformio

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [esp32_application, esp32s3_application]
      fail-fast: false
    
    container:
      image: ghcr.io/marcespuna/rtls-link-platformio:v1.0.0
      credentials:
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Cache PlatformIO Core and Packages
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.PIO_CACHE }}
          .pio/libdeps
          .pio/build/${{ matrix.environment }}/.pioenvs
        key: ${{ runner.os }}-pio-${{ matrix.environment }}-${{ hashFiles('platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-${{ matrix.environment }}-
          ${{ runner.os }}-pio-
    
    - name: Set PlatformIO Environment
      run: |
        # All PlatformIO state goes into $PIO_CACHE, which is a directory
        # inside the repository workspace and therefore survives the end
        # of the container.
        export PLATFORMIO_HOME="$PIO_CACHE"
        export PLATFORMIO_CORE_DIR="$PIO_CACHE"
        echo "PLATFORMIO_HOME=$PIO_CACHE" >> $GITHUB_ENV
        echo "PLATFORMIO_CORE_DIR=$PIO_CACHE" >> $GITHUB_ENV
    
    - name: PlatformIO System Info
      run: pio system info
    
    - name: Pre-install Platform and Framework
      run: |
        # Pre-install ESP32 platform to avoid download during build
        pio platform install espressif32
        pio platform show espressif32
    
    - name: Install Project Dependencies
      run: |
        echo "Installing dependencies for ${{ matrix.environment }}"
        pio pkg install --environment ${{ matrix.environment }}
    
    - name: Check Libraries
      run: |
        echo "ðŸ“š Installed packages:"
        pio pkg list
        echo ""
        echo "ðŸ“ Library dependencies for ${{ matrix.environment }}:"
        ls -la .pio/libdeps/${{ matrix.environment }}/ || echo "No libdeps directory yet"
    
    - name: Build ${{ matrix.environment }}
      run: |
        echo "ðŸ”¨ Building environment: ${{ matrix.environment }}"
        pio run --environment ${{ matrix.environment }}
    
    - name: Verify Build Output
      run: |
        BUILD_DIR=".pio/build/${{ matrix.environment }}"
        echo "ðŸ“ Build directory contents:"
        ls -la "$BUILD_DIR/"
        
        if [ -f "$BUILD_DIR/firmware.bin" ]; then
          echo "âœ… Firmware binary created successfully"
          echo "ðŸ“¦ Firmware size:"
          ls -lh "$BUILD_DIR/firmware.bin"
          
          # Show memory usage
          if [ -f "$BUILD_DIR/firmware.elf" ]; then
            echo "ðŸ§  Memory usage:"
            pio run --environment ${{ matrix.environment }} --target size
          fi
        else
          echo "âŒ Firmware binary not found!"
          exit 1
        fi
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: firmware-${{ matrix.environment }}-${{ github.run_number }}
        path: |
          .pio/build/${{ matrix.environment }}/firmware.bin
          .pio/build/${{ matrix.environment }}/firmware.elf
          .pio/build/${{ matrix.environment }}/bootloader.bin
          .pio/build/${{ matrix.environment }}/partitions.bin
        retention-days: 7
    
    - name: Generate Build Report
      if: success()
      run: |
        BUILD_DIR=".pio/build/${{ matrix.environment }}"
        
        echo "ðŸ“Š Build Report for ${{ matrix.environment }}"
        echo "## ðŸ“Š Build Report for \`${{ matrix.environment }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "$BUILD_DIR/firmware.bin" ]; then
          FIRMWARE_SIZE=$(stat -c%s "$BUILD_DIR/firmware.bin" 2>/dev/null)
          echo "ðŸ“¦ Firmware Size: ${FIRMWARE_SIZE} bytes"
          echo "- **Firmware Size:** ${FIRMWARE_SIZE} bytes" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo ""
        echo "ðŸ§  Memory Usage:"
        pio run --environment ${{ matrix.environment }} --target size
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Memory Usage" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        pio run --environment ${{ matrix.environment }} --target size >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  # Job summary
  build-summary:
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
    - name: Build Summary
      run: |
        echo "## ðŸŽ¯ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.build.result }}" == "success" ]; then
          echo "âœ… **All ESP32 environments built successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Both \`esp32_application\` and \`esp32s3_application\` environments compiled without errors." >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Some builds failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the individual job logs for details." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi 